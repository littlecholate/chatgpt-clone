æ²’å•é¡Œï¼å°‡ç¨‹å¼ç¢¼æ¨¡çµ„åŒ–æ˜¯å°ˆæ¡ˆèµ°å‘æˆç†Ÿçš„å¿…ç¶“ä¹‹è·¯ã€‚é€™æ¨£åšå¯ä»¥è®“ç¨‹å¼ç¢¼æ›´æ˜“è®€ã€æ›´å¥½ç¶­è­·ï¼Œè€Œä¸”è‹¥æœªä¾†è¦æ›ä¸åŒçš„ LLM æˆ–å¢åŠ åŠŸèƒ½æ™‚ï¼Œä¸æœƒå‹•åˆ°æ ¸å¿ƒé‚è¼¯ã€‚

æˆ‘ç‚ºæ‚¨è¨­è¨ˆäº†ä¸€å€‹æ¨™æº–çš„ Node.js åˆ†å±¤æ¶æ§‹ï¼š

ğŸ“‚ å»ºè­°çš„å°ˆæ¡ˆçµæ§‹
Plaintext

my-teams-bot/
â”œâ”€â”€ .env                  # ç’°å¢ƒè®Šæ•¸ (æ©Ÿå¯†è³‡æ–™)
â”œâ”€â”€ package.json          # å°ˆæ¡ˆä¾è³´å®šç¾©
â”œâ”€â”€ index.js              # [å…¥å£] ç¨‹å¼å•Ÿå‹•é»
â””â”€â”€ src/
    â”œâ”€â”€ config.js         # [è¨­å®š] é›†ä¸­ç®¡ç†ç’°å¢ƒè®Šæ•¸èˆ‡å¸¸æ•¸
    â”œâ”€â”€ bot.js            # [æ ¸å¿ƒ] Bot çš„ä¸»è¦é‚è¼¯ (å·¡é‚ã€æª¢æŸ¥ã€ç‹€æ…‹ç®¡ç†)
    â”œâ”€â”€ services/
    â”‚   â”œâ”€â”€ auth.js       # [æœå‹™] è² è²¬å–å¾— Token (ROPC)
    â”‚   â””â”€â”€ graph.js      # [æœå‹™] è² è²¬æ‰€æœ‰èˆ‡ Microsoft Graph API çš„äº’å‹•
    â””â”€â”€ utils/
        â””â”€â”€ formatter.js  # [å·¥å…·] Markdown è½‰ HTML ç­‰æ ¼å¼è™•ç†
1. src/config.js (è¨­å®šæª”)
å°‡æ‰€æœ‰ process.env çš„è®€å–æ”¾åœ¨é€™è£¡ã€‚å¦‚æœç¼ºå°‘è®Šæ•¸ï¼Œé€™è£¡å¯ä»¥ç›´æ¥å ±éŒ¯ï¼Œé¿å…ç¨‹å¼è·‘åˆ°ä¸€åŠæ‰å´©æ½°ã€‚

JavaScript

require('dotenv').config();

const config = {
    clientId: process.env.CLIENT_ID,
    clientSecret: process.env.CLIENT_SECRET,
    tenantId: process.env.TENANT_ID,
    ropcUsername: process.env.ROPC_USERNAME,
    ropcPassword: process.env.ROPC_PASSWORD,
    pollInterval: parseInt(process.env.POLL_INTERVAL_MS || 5000),
    graphEndpoint: 'https://graph.microsoft.com/v1.0',
    authEndpoint: `https://login.microsoftonline.com/${process.env.TENANT_ID}/oauth2/v2.0/token`
};

// ç°¡å–®é˜²å‘†æª¢æŸ¥
const requiredKeys = ['clientId', 'clientSecret', 'tenantId', 'ropcUsername', 'ropcPassword'];
const missingKeys = requiredKeys.filter(key => !config[key]);

if (missingKeys.length > 0) {
    console.error(`éŒ¯èª¤: .env æª”æ¡ˆç¼ºå°‘ä»¥ä¸‹è¨­å®š: ${missingKeys.join(', ')}`);
    process.exit(1);
}

module.exports = config;
2. src/services/auth.js (é©—è­‰æœå‹™)
å°ˆé–€è² è²¬è·Ÿ Azure AD æ‰“äº¤é“ï¼Œæ‹¿åˆ° Tokenã€‚

JavaScript

const axios = require('axios');
const querystring = require('querystring');
const config = require('../config');

async function getGraphToken() {
    const postData = {
        client_id: config.clientId,
        scope: 'https://graph.microsoft.com/.default',
        grant_type: 'password',
        username: config.ropcUsername,
        password: config.ropcPassword,
        client_secret: config.clientSecret
    };

    try {
        const response = await axios.post(config.authEndpoint, querystring.stringify(postData), {
            headers: { 'Content-Type': 'application/x-www-form-urlencoded' }
        });
        return response.data.access_token;
    } catch (error) {
        console.error("[Auth] å–å¾— Token å¤±æ•—:", error.response ? error.response.data : error.message);
        return null;
    }
}

module.exports = { getGraphToken };
3. src/services/graph.js (Graph API æœå‹™)
é€™è£¡å°è£äº†æ‰€æœ‰ axios è«‹æ±‚ã€‚Bot çš„é‚è¼¯å±¤ä¸éœ€è¦çŸ¥é“ API URL é•·ä»€éº¼æ¨£å­ï¼Œåªéœ€è¦å‘¼å«å‡½å¼ã€‚

JavaScript

const axios = require('axios');
const config = require('../config');

// å»ºç«‹ä¸€å€‹é è¨­é…ç½®çš„ axios å¯¦ä¾‹
const graphClient = axios.create({
    baseURL: config.graphEndpoint
});

// å–å¾—è‡ªå·±çš„ User ID
async function getMyUserId(token) {
    const res = await graphClient.get('/me', {
        headers: { 'Authorization': `Bearer ${token}` }
    });
    return res.data.id;
}

// å–å¾—æœ€è¿‘æœ‰æ›´æ–°çš„èŠå¤©å®¤åˆ—è¡¨
async function getRecentChats(token, top = 10) {
    const url = `/chats?$orderby=lastUpdatedDateTime desc&$top=${top}`;
    const res = await graphClient.get(url, {
        headers: { 'Authorization': `Bearer ${token}` }
    });
    return res.data.value || [];
}

// å–å¾—ç‰¹å®šèŠå¤©å®¤çš„æœ€æ–°ä¸€å‰‡è¨Šæ¯
async function getLatestMessage(token, chatId) {
    const url = `/chats/${chatId}/messages?$orderby=createdDateTime desc&$top=1`;
    const res = await graphClient.get(url, {
        headers: { 'Authorization': `Bearer ${token}` }
    });
    return (res.data.value && res.data.value.length > 0) ? res.data.value[0] : null;
}

// ç™¼é€ HTML å›è¦†
async function sendHtmlReply(token, chatId, htmlContent) {
    const url = `/chats/${chatId}/messages`;
    await graphClient.post(url, {
        body: {
            contentType: 'html',
            content: htmlContent
        }
    }, {
        headers: { 'Authorization': `Bearer ${token}` }
    });
}

module.exports = {
    getMyUserId,
    getRecentChats,
    getLatestMessage,
    sendHtmlReply
};
4. src/utils/formatter.js (æ ¼å¼è™•ç†å·¥å…·)
è™•ç† Markdown è½‰ HTMLã€‚

JavaScript

const { marked } = require('marked');

function convertMarkdownToHtml(text) {
    if (!text) return '';
    // å¯ä»¥åŠ å…¥æ›´å¤šçš„å®¢è£½åŒ–è™•ç†
    return marked.parse(text);
}

module.exports = { convertMarkdownToHtml };
5. src/bot.js (Bot æ ¸å¿ƒé‚è¼¯)
é€™æ˜¯å¤§è…¦ã€‚å®ƒç®¡ç†ç‹€æ…‹ (checkpoints)ï¼Œä¸¦å”èª¿å„å€‹æœå‹™ä¾†å®Œæˆä»»å‹™ã€‚

JavaScript

const authService = require('./services/auth');
const graphService = require('./services/graph');
const formatter = require('./utils/formatter');

// ç‹€æ…‹ç®¡ç†ï¼šè¨˜éŒ„æ¯å€‹èŠå¤©å®¤è®€å–åˆ°çš„ Message ID
let chatCheckpoints = {};
let myUserId = null;

async function startPolling() {
    console.log("æ­£åœ¨å–å¾— Access Token...");
    const token = await authService.getGraphToken();
    if (!token) return;

    // ç¬¬ä¸€æ¬¡åŸ·è¡Œæ™‚ï¼Œå–å¾— Bot è‡ªå·±çš„ ID
    if (!myUserId) {
        try {
            myUserId = await graphService.getMyUserId(token);
            console.log(`[System] Bot User ID: ${myUserId}`);
        } catch (e) {
            console.error("[System] ç„¡æ³•å–å¾— Bot IDï¼Œç•¥éæœ¬æ¬¡å¾ªç’°");
            return;
        }
    }

    try {
        // 1. å–å¾—æ´»èºèŠå¤©å®¤
        const activeChats = await graphService.getRecentChats(token);

        // 2. å¹³è¡Œè™•ç†æ¯å€‹èŠå¤©å®¤
        const promises = activeChats.map(chat => processSingleChat(token, chat.id));
        await Promise.all(promises);

    } catch (e) {
        console.error("[Loop] å·¡é‚ç™¼ç”ŸéŒ¯èª¤:", e.message);
    }
}

// è™•ç†å–®ä¸€èŠå¤©å®¤çš„é‚è¼¯
async function processSingleChat(token, chatId) {
    try {
        const latestMsg = await graphService.getLatestMessage(token, chatId);
        if (!latestMsg) return;

        const msgId = latestMsg.id;

        // æª¢æŸ¥ Checkpoint
        if (chatCheckpoints[chatId] === msgId) return;

        // æª¢æŸ¥æ˜¯å¦ç‚ºè‡ªå·±ç™¼çš„
        const senderId = (latestMsg.from && latestMsg.from.user) ? latestMsg.from.user.id : null;
        if (senderId === myUserId) {
            chatCheckpoints[chatId] = msgId; // æ›´æ–° checkpoint
            return;
        }

        // --- è™•ç†æ–°è¨Šæ¯ ---
        const senderName = latestMsg.from.user ? latestMsg.from.user.displayName : 'æœªçŸ¥';
        const rawContent = (latestMsg.body.content || '').replace(/<[^>]*>/g, '').trim();

        console.log(`[New Msg] Chat: ${chatId} | From: ${senderName} | Content: ${rawContent}`);
        
        // æ›´æ–° Checkpoint (é˜²æ­¢é‡è¤‡è™•ç†)
        chatCheckpoints[chatId] = msgId;

        // --- æ¥­å‹™é‚è¼¯ (LLM æ•´åˆé») ---
        if (rawContent) {
            // æ¨¡æ“¬ LLM å›æ‡‰
            const replyText = `**Bot å›è¦† ${senderName}**: æˆ‘æ”¶åˆ°äº†ä½ çš„è¨Šæ¯: "${rawContent}"`;
            const htmlReply = formatter.convertMarkdownToHtml(replyText);

            await graphService.sendHtmlReply(token, chatId, htmlReply);
            console.log(`[Reply] å·²å›è¦†çµ¦ ${senderName}`);
        }

    } catch (e) {
        console.error(`[Chat Error] è™•ç†èŠå¤©å®¤ ${chatId} å¤±æ•—:`, e.message);
    }
}

module.exports = { startPolling };
6. index.js (å…¥å£æª”æ¡ˆ)
ä¿æŒæ¥µç°¡ï¼Œåªè² è²¬å•Ÿå‹•ã€‚

JavaScript

const config = require('./src/config');
const bot = require('./src/bot');

console.log("========================================");
console.log("   Teams Polling Bot (Multi-Chat) v2    ");
console.log(`   Poll Interval: ${config.pollInterval / 1000}s`);
console.log("========================================");

// ç«‹å³åŸ·è¡Œä¸€æ¬¡
bot.startPolling();

// è¨­å®šæ’ç¨‹
setInterval(() => {
    bot.startPolling();
}, config.pollInterval);
é€™æ¨£æ‹†åˆ†çš„å¥½è™•
é—œæ³¨é»åˆ†é›¢ (Separation of Concerns)ï¼š

graph.js åªç®¡ç™¼è«‹æ±‚ï¼Œä¸ç®¡é‚è¼¯ã€‚

bot.js åªç®¡é‚è¼¯ï¼Œä¸ç®¡ HTTP Header æ€éº¼çµ„ã€‚

auth.js å£äº†å°±ä¿® auth.jsï¼Œä¸æœƒæ”¹å£åˆ¥çš„åœ°æ–¹ã€‚

å¯æ“´å……æ€§ï¼š

å¦‚æœæ‚¨æƒ³å¢åŠ ã€Œä¸‹è¼‰åœ–ç‰‡ã€åŠŸèƒ½ï¼Œåªè¦åœ¨ graph.js åŠ ä¸€å€‹ downloadImage å‡½å¼ï¼Œç„¶å¾Œåœ¨ bot.js å‘¼å«å³å¯ã€‚

å¦‚æœæ‚¨æƒ³æŠŠ LLM å¾æ¨¡æ“¬æ”¹æˆ OpenAIï¼Œåªè¦åœ¨ bot.js çš„ã€Œæ¥­å‹™é‚è¼¯ã€å€å¡Šä¿®æ”¹å³å¯ã€‚

å®‰å…¨æ€§ï¼š

æ‰€æœ‰ç’°å¢ƒè®Šæ•¸æª¢æŸ¥éƒ½åœ¨ config.js ä¸€é–‹å§‹å°±åšå®Œï¼Œä¸æœƒç™¼ç”Ÿç¨‹å¼è·‘äº†ä¸‰å¤©å¾Œå› ç‚ºç¼ºå°‘è®Šæ•¸è€Œæ›æ‰ã€‚

ç¾åœ¨æ‚¨å¯ä»¥ç›´æ¥å»ºç«‹é€™äº›æª”æ¡ˆï¼Œå°‡ç¨‹å¼ç¢¼è²¼å…¥å³å¯é‹è¡Œï¼
