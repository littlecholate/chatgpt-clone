ç¾åœ¨é‚„æœ‰å€‹å•é¡Œï¼Œæ¯æ¬¡é‡æ–°åŸ·è¡Œç’°å¢ƒå‰æˆ‘éƒ½éœ€è¦è¼¸å…¥ set NODE_TLS_REJECT_UNAUTHORIZED=0, å¦å‰‡æœƒè·³å‡º error, é€™è¦å¦‚ä½•è§£æ±ºï¼Ÿ

é€™æ˜¯ä¸€å€‹åœ¨ä¼æ¥­å…§éƒ¨ç¶²è·¯é–‹ç™¼æ™‚éå¸¸ç¶“å…¸çš„ç—›é»ã€‚

é›–ç„¶ã€Œæ­£ç¢ºã€çš„è§£æ³•æ˜¯è«‹ MIS é–‹é€šé˜²ç«ç‰†çš„ CRL/OCSP é©—è­‰ç¶²å€ï¼Œä½†ç‚ºäº†é–‹ç™¼æ•ˆç‡ï¼Œæˆ‘å€‘å¯ä»¥ç›´æ¥åœ¨å°ˆæ¡ˆå±¤ç´šè‡ªå‹•åŒ–é€™å€‹è¨­å®šï¼Œè®“æ‚¨ä¸ç”¨æ¯æ¬¡æ‰‹å‹•è¼¸å…¥ã€‚

ä»¥ä¸‹æœ‰ä¸‰ç¨®æ–¹æ³•ï¼Œæ¨è–¦æ‚¨ä½¿ç”¨æ–¹æ³•ä¸€æœ€ç°¡å–®ã€‚

æ–¹æ³•ä¸€ï¼šå¯«å…¥ .env æª”æ¡ˆ (æœ€æ¨è–¦)
æ—¢ç„¶æ‚¨çš„å°ˆæ¡ˆå·²ç¶“ä½¿ç”¨äº† dotenv å¥—ä»¶ï¼Œæ‚¨å¯ä»¥ç›´æ¥å°‡é€™å€‹è¨­å®šç•¶ä½œä¸€å€‹ç’°å¢ƒè®Šæ•¸ã€‚

æ‰“é–‹æ‚¨çš„ .env æª”æ¡ˆã€‚

åœ¨ä»»ä½•ä¸€è¡ŒåŠ å…¥ï¼š

ç¨‹å¼ç¢¼ç‰‡æ®µ
NODE_TLS_REJECT_UNAUTHORIZED=0
åŸç†ï¼š ç•¶æ‚¨çš„ç¨‹å¼åŸ·è¡Œ require('dotenv').config() æ™‚ï¼Œå®ƒæœƒè‡ªå‹•æŠŠé€™å€‹è®Šæ•¸è¼‰å…¥åˆ° process.env ä¸­ï¼ŒNode.js çš„ HTTPS æ¨¡çµ„è®€åˆ°é€™å€‹è¨­å®šå¾Œï¼Œå°±æœƒç•¥éæ†‘è­‰æª¢æŸ¥ã€‚

æ–¹æ³•äºŒï¼šå¯«åœ¨ index.js çš„æœ€ä¸Šæ–¹ (æœ€æš´åŠ›æœ‰æ•ˆ)
å¦‚æœæ‚¨æ“”å¿ƒ .env è¼‰å…¥çš„æ™‚é–“é»ä¸å¤ æ—©ï¼Œæ‚¨å¯ä»¥ç›´æ¥æŠŠå®ƒå¯«æ­»åœ¨ç¨‹å¼çš„ç¬¬ä¸€è¡Œã€‚

æ‰“é–‹æ‚¨çš„å…¥å£æª”æ¡ˆï¼ˆä¾‹å¦‚ index.jsï¼‰ï¼Œåœ¨æ‰€æœ‰ require ä¹‹å‰åŠ å…¥é€™è¡Œï¼š

JavaScript
// [åš´é‡è­¦å‘Š] åƒ…é™é–‹ç™¼ç’°å¢ƒä½¿ç”¨ï¼šå¿½ç•¥ SSL æ†‘è­‰é©—è­‰ (è§£æ±ºå…¬å¸å…§ç¶²æ†‘è­‰æ’¤éŠ·æª¢æŸ¥å¤±æ•—å•é¡Œ)
process.env.NODE_TLS_REJECT_UNAUTHORIZED = '0';

// ä¸‹é¢æ‰æ˜¯åŸæœ¬çš„ç¨‹å¼ç¢¼
const config = require('./src/config');
// ...
é€™æ¨£æ¯æ¬¡æ‚¨è·‘ node index.js æ™‚ï¼Œç¨‹å¼ç¢¼è‡ªå·±å°±æœƒå…ˆè¨­å®šå¥½ç’°å¢ƒè®Šæ•¸ã€‚

æ–¹æ³•ä¸‰ï¼šä¿®æ”¹ package.json (å•Ÿå‹•è…³æœ¬)
å¦‚æœæ‚¨ç¿’æ…£ç”¨ npm start ä¾†å•Ÿå‹•ç¨‹å¼ï¼Œå¯ä»¥ä¿®æ”¹ package.json çš„ scripts å€å¡Šã€‚

Windows (CMD) å¯«æ³•ï¼š

JSON
"scripts": {
  "start": "set NODE_TLS_REJECT_UNAUTHORIZED=0 && node index.js"
}
è·¨å¹³å° (Windows/Mac/Linux) å¯«æ³•ï¼š (éœ€å…ˆå®‰è£ npm install cross-env --save-dev)

JSON
"scripts": {
  "start": "cross-env NODE_TLS_REJECT_UNAUTHORIZED=0 node index.js"
}
ä¹‹å¾Œæ‚¨åªè¦è¼¸å…¥ npm startï¼Œå®ƒå°±æœƒè‡ªå‹•å¸¶å…¥é€™å€‹è¨­å®šä¸¦å•Ÿå‹•ç¨‹å¼ã€‚

âš ï¸ é‡è¦è³‡å®‰æé†’
è«‹è¨˜å¾—ï¼ŒNODE_TLS_REJECT_UNAUTHORIZED=0 çš„æ„æ€æ˜¯å‘Šè¨´ Node.jsï¼šã€Œå³ä½¿ä¼ºæœå™¨çš„èº«åˆ†è­‰ (SSL) æ˜¯å‡çš„ã€éæœŸçš„ã€æˆ–ç„¡æ³•é©—è­‰çš„ï¼Œä¹Ÿè«‹ç„¡æ¢ä»¶ä¿¡ä»»å®ƒã€‚ã€

é–‹ç™¼éšæ®µï¼š åœ¨å…¬å¸å…§ç¶²é‡åˆ°é˜²ç«ç‰†é˜»æ“‹ CRL æª¢æŸ¥æ™‚ï¼Œé€™æ¨£åšæ˜¯ OK çš„ã€‚

æ­£å¼ä¸Šç·šï¼š å¦‚æœæœªä¾†é€™å€‹ Bot è¦éƒ¨ç½²åˆ°é›²ç«¯æˆ–ç”Ÿç”¢ç’°å¢ƒï¼Œè«‹å‹™å¿…ç§»é™¤é€™è¡Œè¨­å®šï¼Œå¦å‰‡æ‚¨çš„ Bot æœƒå®¹æ˜“å—åˆ°ã€Œä¸­é–“äººæ”»æ“Š (Man-in-the-Middle Attack)ã€ã€‚

å¦‚æœæˆ‘æœ‰å¾ˆå¤šä¸åŒçš„robot account, å„è‡ªæœ‰client idå’Œsecretï¼Œæˆ‘è©²å¦‚ä½•åœ¨éƒ¨ç½²æ™‚æˆ–ç¨‹å¼å…§æ”¯æ´å¤šå€‹bot? æœªä¾†ä¹Ÿå¯èƒ½æœƒæ“´å……

é€™æ˜¯ä¸€å€‹å¾ã€Œå–®ä¸€è…³æœ¬ã€é‚å‘ã€Œç³»çµ±åŒ–æ¶æ§‹ã€çš„é—œéµè½‰è®Šã€‚

è¦æ”¯æ´å¤šå€‹ Robotï¼Œæœ€æ ¸å¿ƒçš„è§€å¿µæ˜¯ï¼šå°‡ã€Œè¨­å®šã€èˆ‡ã€Œé‚è¼¯ã€åˆ†é›¢ï¼Œä¸¦å°‡ Bot çš„ç‹€æ…‹å°è£èµ·ä¾†ã€‚

ç›®å‰æ‚¨çš„ç¨‹å¼ç¢¼å¤§å¤šæ˜¯ä½¿ç”¨å…¨åŸŸè®Šæ•¸ï¼ˆä¾‹å¦‚ chatCheckpoints, myUserIdï¼‰ï¼Œå¦‚æœåŒæ™‚è·‘å…©å€‹ Botï¼Œé€™äº›è®Šæ•¸æœƒæ‰“æ¶ã€‚

è§£æ±ºæ–¹æ¡ˆæ˜¯æ¡ç”¨ ç‰©ä»¶å°å‘ (Class-based) çš„è¨­è¨ˆæ¨¡å¼ã€‚æ¯ä¸€å€‹ Bot éƒ½æ˜¯é€™å€‹ Class çš„ä¸€å€‹ å¯¦ä¾‹ (Instance)ï¼Œæ“æœ‰è‡ªå·±ç¨ç«‹çš„ Tokenã€ID å’Œæª¢æŸ¥é»ã€‚

ä»¥ä¸‹æ˜¯ä¿®æ”¹æ­¥é©Ÿï¼š

1. ä¿®æ”¹ .env (é…ç½®å¤šçµ„å¸³å¯†)
ç‚ºäº†å®‰å…¨ï¼Œå¯†ç¢¼ä¾ç„¶ä¸èƒ½é€²ç¨‹å¼ç¢¼ï¼Œæˆ‘å€‘ä½¿ç”¨å‰ç¶´ä¾†å€åˆ†ä¸åŒ Botã€‚

ç¨‹å¼ç¢¼ç‰‡æ®µ
# === å…¨åŸŸè¨­å®š ===
TENANT_ID="common_tenant_id"
POLL_INTERVAL_MS=5000

# === Robot 1: HR å°å¹«æ‰‹ ===
BOT_1_NAME="HR_Bot"
BOT_1_CLIENT_ID="aaaaaaaa-aaaa-aaaa-aaaa-aaaaaaaaaaaa"
BOT_1_SECRET="secret_a"
BOT_1_USER="hr_robot@company.com"
BOT_1_PASS="password_a"

# === Robot 2: IT å ±ä¿®å–® ===
BOT_2_NAME="IT_Bot"
BOT_2_CLIENT_ID="bbbbbbbb-bbbb-bbbb-bbbb-bbbbbbbbbbbb"
BOT_2_SECRET="secret_b"
BOT_2_USER="it_robot@company.com"
BOT_2_PASS="password_b"
2. ä¿®æ”¹ src/config.js (å›å‚³é™£åˆ—)
æˆ‘å€‘ä¸å†å›å‚³å–®ä¸€çµ„è¨­å®šï¼Œè€Œæ˜¯å›å‚³ä¸€å€‹ Bot è¨­å®šåˆ—è¡¨ã€‚

JavaScript
require('dotenv').config();

const common = {
    tenantId: process.env.TENANT_ID,
    pollInterval: parseInt(process.env.POLL_INTERVAL_MS || 5000),
    graphEndpoint: 'https://graph.microsoft.com/v1.0', // æˆ– beta
    authEndpoint: `https://login.microsoftonline.com/${process.env.TENANT_ID}/oauth2/v2.0/token`
};

// å®šç¾© Bot åˆ—è¡¨
const bots = [
    {
        name: process.env.BOT_1_NAME || 'Bot 1',
        clientId: process.env.BOT_1_CLIENT_ID,
        clientSecret: process.env.BOT_1_SECRET,
        username: process.env.BOT_1_USER,
        password: process.env.BOT_1_PASS
    },
    {
        name: process.env.BOT_2_NAME || 'Bot 2',
        clientId: process.env.BOT_2_CLIENT_ID,
        clientSecret: process.env.BOT_2_SECRET,
        username: process.env.BOT_2_USER,
        password: process.env.BOT_2_PASS
    }
    // æœªä¾†è¦æ“´å……ï¼Œåªè¦åœ¨é€™è£¡åŠ æ–°çš„ç‰©ä»¶ï¼Œä¸¦å» .env åŠ è®Šæ•¸å³å¯
];

// éæ¿¾æ‰æ²’æœ‰è¨­å®šå®Œæ•´çš„ Bot (é˜²æ­¢å ±éŒ¯)
const activeBots = bots.filter(b => b.clientId && b.password);

module.exports = {
    common,
    bots: activeBots
};
3. ä¿®æ”¹ src/services/auth.js (æ¥æ”¶åƒæ•¸)
é©—è­‰å‡½å¼ä¸èƒ½å†è®€å–å…¨åŸŸ configï¼Œå¿…é ˆæ¥å—åƒæ•¸ã€‚

JavaScript
const axios = require('axios');
const querystring = require('querystring');
const { common } = require('../config'); // åªè®€å–é€šç”¨è¨­å®š

// ç¾åœ¨é€™å€‹å‡½å¼æ˜¯ç´”ç²¹çš„å·¥å…·ï¼Œä¸ç¶å®šç‰¹å®š Bot
async function getGraphToken(botCreds) {
    const postData = {
        client_id: botCreds.clientId,
        scope: 'https://graph.microsoft.com/.default',
        grant_type: 'password',
        username: botCreds.username,
        password: botCreds.password,
        client_secret: botCreds.clientSecret
    };

    try {
        const response = await axios.post(common.authEndpoint, querystring.stringify(postData), {
            headers: { 'Content-Type': 'application/x-www-form-urlencoded' }
        });
        return response.data.access_token;
    } catch (error) {
        console.error(`[Auth] ${botCreds.name} å–å¾— Token å¤±æ•—:`, error.message);
        return null;
    }
}

module.exports = { getGraphToken };
4. é‡æ§‹ src/bot.js (æ”¹ç‚º Class)
é€™æ˜¯æœ€é—œéµçš„ä¸€æ­¥ã€‚æˆ‘å€‘å°‡ä¹‹å‰çš„é‚è¼¯å°è£æˆä¸€å€‹é¡åˆ¥ã€‚

JavaScript
const authService = require('./services/auth');
const graphService = require('./services/graph');
const formatter = require('./utils/formatter');

class PollingBot {
    constructor(botConfig) {
        this.config = botConfig;
        this.name = botConfig.name;
        
        // æ¯å€‹ Bot æ“æœ‰è‡ªå·±ç¨ç«‹çš„ç‹€æ…‹
        this.chatCheckpoints = {}; 
        this.myUserId = null;
    }

    // å•Ÿå‹•ä¸€æ¬¡å·¡é‚
    async runCycle() {
        // console.log(`[${this.name}] é–‹å§‹å·¡é‚...`);
        
        // 1. å–å¾—è©² Bot çš„ Token
        const token = await authService.getGraphToken(this.config);
        if (!token) return;

        // 2. å–å¾—è©² Bot çš„ User ID (åªåšä¸€æ¬¡)
        if (!this.myUserId) {
            try {
                this.myUserId = await graphService.getMyUserId(token);
                console.log(`[${this.name}] IDç¢ºèª: ${this.myUserId}`);
            } catch (e) {
                console.error(`[${this.name}] ç„¡æ³•å–å¾— User ID`);
                return;
            }
        }

        try {
            // 3. å–å¾—è©² Bot çš„æ´»èºèŠå¤©å®¤
            const activeChats = await graphService.getRecentChats(token);

            // 4. å¹³è¡Œè™•ç†
            const promises = activeChats.map(chat => this.processSingleChat(token, chat.id));
            await Promise.all(promises);

        } catch (e) {
            console.error(`[${this.name}] å·¡é‚éŒ¯èª¤:`, e.message);
        }
    }

    async processSingleChat(token, chatId) {
        try {
            const latestMsg = await graphService.getLatestMessage(token, chatId);
            if (!latestMsg) return;

            const msgId = latestMsg.id;

            // ä½¿ç”¨ this.chatCheckpoints (è‡ªå·±çš„è¨˜æ†¶é«”)
            if (this.chatCheckpoints[chatId] === msgId) return;

            // æª¢æŸ¥æ˜¯å¦ç‚ºè‡ªå·±ç™¼çš„
            const senderId = (latestMsg.from && latestMsg.from.user) ? latestMsg.from.user.id : null;
            if (senderId === this.myUserId) {
                this.chatCheckpoints[chatId] = msgId;
                return;
            }

            // --- è™•ç†è¨Šæ¯ ---
            const senderName = latestMsg.from.user ? latestMsg.from.user.displayName : 'æœªçŸ¥';
            const rawContent = (latestMsg.body.content || '').replace(/<[^>]*>/g, '').trim();

            console.log(`[${this.name}] æ”¶åˆ°ä¾†è‡ª ${senderName}: ${rawContent}`);
            this.chatCheckpoints[chatId] = msgId;

            if (rawContent) {
                // é€™è£¡å¯ä»¥ä¾æ“š this.name åšä¸åŒçš„æ¥­å‹™é‚è¼¯
                let replyText = `**${this.name} å›è¦†**: ${rawContent}`;
                
                // ä¾‹å¦‚ï¼šå¦‚æœæ˜¯ IT Botï¼ŒåŠ ä¸Šç‰¹æ®Šé‚è¼¯
                if (this.name === 'IT_Bot') replyText += " (IT å ±ä¿®è™•ç†ä¸­...)";

                const htmlReply = formatter.convertMarkdownToHtml(replyText);
                await graphService.sendHtmlReply(token, chatId, htmlReply);
            }

        } catch (e) {
            console.error(`[${this.name}] è™•ç†èŠå¤©å®¤ ${chatId} å¤±æ•—:`, e.message);
        }
    }
}

module.exports = PollingBot;
5. ä¿®æ”¹ index.js (è¿´åœˆå•Ÿå‹•)
æœ€å¾Œï¼Œåœ¨å…¥å£æª”æ¡ˆä¸­ï¼Œæˆ‘å€‘åˆå§‹åŒ–æ‰€æœ‰çš„ Botã€‚

JavaScript
const { bots, common } = require('./src/config'); // æ³¨æ„é€™è£¡å¼•å…¥çµæ§‹è®Šäº†
const PollingBot = require('./src/bot');

console.log("========================================");
console.log(`   Multi-Bot System Starting...`);
console.log(`   Active Bots: ${bots.length}`);
console.log("========================================");

// 1. å¯¦ä¾‹åŒ–æ‰€æœ‰ Bot
const botInstances = bots.map(botConfig => new PollingBot(botConfig));

// 2. å®šç¾©å·¡é‚å‡½å¼
async function runAllBots() {
    // è®“æ‰€æœ‰ Bot å¹³è¡ŒåŸ·è¡Œä¸€æ¬¡å·¡é‚
    const promises = botInstances.map(bot => bot.runCycle());
    await Promise.all(promises);
}

// 3. å•Ÿå‹•
runAllBots();

setInterval(() => {
    runAllBots();
}, common.pollInterval);
é€™æ¨£åšçš„å¥½è™•
å®Œå…¨éš”é›¢ï¼š Robot A çš„è¨Šæ¯ç‹€æ…‹ä¸æœƒæ±¡æŸ“ Robot Bã€‚

å®¹æ˜“æ“´å……ï¼š æœªä¾†è¦åŠ  Robot Cï¼Œæ‚¨åªéœ€è¦ä¿®æ”¹ .env å’Œ config.jsï¼Œå®Œå…¨ä¸éœ€è¦å‹• bot.js æˆ– index.js çš„ç¨‹å¼ç¢¼ã€‚

é‚è¼¯å®¢è£½åŒ–ï¼š æ‚¨å¯ä»¥åœ¨ bot.js è£¡é¢é€é if (this.name === '...') ä¾†ç‚ºä¸åŒçš„æ©Ÿå™¨äººå¯«ä¸åŒçš„è™•ç†é‚è¼¯ï¼Œæˆ–è€…ä¹¾è„†ç¹¼æ‰¿ Class ä¾†è¦†å¯«ã€‚

æ¥è‘—æˆ‘æƒ³åŠ ä¸€äº›é€²éšåŠŸèƒ½ï¼Œç•¶userå‚³é€è¨Šæ¯æ™‚ï¼Œå¦‚æœæ˜¯æ–°è¨Šæ¯ï¼Œå‰‡é‡å°user, bot, messageå»ºç«‹çŸ­æš«çš„in-memory-content. æ‰€ä»¥ç•¶useræŒçºŒå•å•é¡Œæ™‚ï¼Œå¯ä»¥è¨˜éŒ„çŸ­æœŸçš„æ­·å²è¨Šæ¯ã€‚ä¸¦ä¸”è¨­å®šç•¶Botæ”¶åˆ°ä¾†è‡ªuserçš„è²¼åœ–å›è¦†ï¼Œæˆ–æ˜¯æ™‚é–“5åˆ†é˜å¾Œï¼Œå‰‡é—œé–‰ä¸¦åˆªé™¤æ­¤æ¬¡è¨Šæ¯çš„in-memory-contentã€‚

é€™æ˜¯ä¸€å€‹éå¸¸æ£’çš„åŠŸèƒ½ï¼Œé€™è®“æ‚¨çš„ Robot å¾ã€Œå–®å•å–®ç­”ã€é€²åŒ–æˆå…·å‚™ã€Œä¸Šä¸‹æ–‡ (Context)ã€èƒ½åŠ›çš„ AI åŠ©ç†ã€‚

é€™åœ¨æŠ€è¡“ä¸Šé€šå¸¸ç¨±ç‚º ã€Œå°è©±ç‹€æ…‹ç®¡ç† (Conversation State Management)ã€ã€‚

æˆ‘å€‘éœ€è¦å¯¦ä½œä¸€å€‹ MemoryManager é¡åˆ¥ï¼Œå®ƒå…·å‚™ä»¥ä¸‹é‚è¼¯ï¼š

å„²å­˜ (Storage): ä½¿ç”¨ Map ä»¥ chatId ç‚º Keyï¼Œå„²å­˜æ­·å²è¨Šæ¯é™£åˆ—ã€‚

æ»‘å‹•è¦–çª— (Sliding Window Timer): æ¯æ¬¡æœ‰æ–°è¨Šæ¯é€²ä¾†ï¼Œå°±æ¸…é™¤èˆŠçš„è¨ˆæ™‚å™¨ï¼Œè¨­å®šæ–°çš„ 5 åˆ†é˜è¨ˆæ™‚å™¨ã€‚æ™‚é–“åˆ°å°±åˆªé™¤è©² chatId çš„è³‡æ–™ã€‚

ä¸­æ–·è§¸ç™¼ (Interrupt): åµæ¸¬è²¼åœ–ï¼Œå¦‚æœç¬¦åˆå‰‡ç«‹å³åŸ·è¡Œåˆªé™¤ã€‚

ä»¥ä¸‹æ˜¯å¯¦ä½œæ­¥é©Ÿèˆ‡ç¨‹å¼ç¢¼ï¼š

1. æ–°å¢ src/services/memory.js
æˆ‘å€‘å°‡è¨˜æ†¶é«”ç®¡ç†çš„é‚è¼¯ç¨ç«‹å‡ºä¾†ï¼Œä¿æŒç¨‹å¼ç¢¼ä¹¾æ·¨ã€‚

JavaScript
// src/services/memory.js

class MemoryManager {
    constructor(ttlSeconds = 300) { // é è¨­ 5 åˆ†é˜ (300ç§’)
        this.ttl = ttlSeconds * 1000;
        this.conversations = new Map(); // ç”¨ Map å„²å­˜æ‰€æœ‰èŠå¤©å®¤çš„ç‹€æ…‹
    }

    /**
     * å–å¾—æŸå€‹èŠå¤©å®¤çš„æ­·å²ç´€éŒ„
     */
    getHistory(chatId) {
        if (!this.conversations.has(chatId)) {
            return [];
        }
        return this.conversations.get(chatId).messages;
    }

    /**
     * æ–°å¢è¨Šæ¯åˆ°æ­·å²ç´€éŒ„ï¼Œä¸¦é‡ç½®è¨ˆæ™‚å™¨
     * @param {string} chatId 
     * @param {string} role - 'user' | 'assistant'
     * @param {string} name - ç™¼è¨€è€…åç¨±
     * @param {string} content - è¨Šæ¯å…§å®¹
     */
    addMessage(chatId, role, name, content) {
        // 1. å¦‚æœæ˜¯æ–°å°è©±ï¼Œåˆå§‹åŒ–çµæ§‹
        if (!this.conversations.has(chatId)) {
            this.conversations.set(chatId, {
                messages: [],
                timer: null
            });
            console.log(`[Memory] æ–°å¢å°è©±ç´€éŒ„: ${chatId}`);
        }

        const session = this.conversations.get(chatId);

        // 2. æ–°å¢è¨Šæ¯
        session.messages.push({ role, name, content, timestamp: Date.now() });

        // 3. é‡ç½®è¨ˆæ™‚å™¨ (Sliding Window)
        this._resetTimer(chatId, session);
    }

    /**
     * å¼·åˆ¶çµæŸå°è©± (ä¾‹å¦‚æ”¶åˆ°è²¼åœ–)
     */
    clearSession(chatId) {
        if (this.conversations.has(chatId)) {
            const session = this.conversations.get(chatId);
            if (session.timer) clearTimeout(session.timer); // æ¸…é™¤è¨ˆæ™‚å™¨
            
            this.conversations.delete(chatId); // åˆªé™¤è³‡æ–™
            console.log(`[Memory] å°è©±å·²çµæŸä¸¦æ¸…é™¤: ${chatId}`);
            return true;
        }
        return false;
    }

    // --- å…§éƒ¨ç§æœ‰æ–¹æ³• ---
    
    _resetTimer(chatId, session) {
        // å¦‚æœå·²ç¶“æœ‰è¨ˆæ™‚å™¨ï¼Œå…ˆæ¸…é™¤ (ä»£è¡¨ä½¿ç”¨è€…é‚„åœ¨è¬›è©±ï¼Œå»¶å¾ŒéæœŸæ™‚é–“)
        if (session.timer) {
            clearTimeout(session.timer);
        }

        // è¨­å®šæ–°çš„è¨ˆæ™‚å™¨
        session.timer = setTimeout(() => {
            console.log(`[Memory] å°è©±é€¾æ™‚ (${this.ttl / 1000}s)ï¼Œè‡ªå‹•æ¸…é™¤: ${chatId}`);
            this.conversations.delete(chatId);
        }, this.ttl);
    }
}

module.exports = MemoryManager;
2. ä¿®æ”¹ src/bot.js
æˆ‘å€‘éœ€è¦åœ¨ Bot åˆå§‹åŒ–æ™‚è¼‰å…¥ MemoryManagerï¼Œä¸¦åœ¨è™•ç†è¨Šæ¯çš„æµç¨‹ä¸­åŠ å…¥ã€Œè²¼åœ–åˆ¤æ–·ã€å’Œã€Œæ­·å²ç´€éŒ„è®€å¯«ã€ã€‚

JavaScript
const authService = require('./services/auth');
const graphService = require('./services/graph');
const formatter = require('./utils/formatter');
const MemoryManager = require('./services/memory'); // [æ–°å¢]

class PollingBot {
    constructor(botConfig) {
        this.config = botConfig;
        this.name = botConfig.name;
        this.chatCheckpoints = {};
        this.myUserId = null;
        
        // [æ–°å¢] æ¯å€‹ Bot æ“æœ‰è‡ªå·±ç¨ç«‹çš„è¨˜æ†¶é«”ç®¡ç†å™¨
        // è¨­å®š 5 åˆ†é˜ (300ç§’)
        this.memory = new MemoryManager(300); 
    }

    // ... (runCycle ä¿æŒä¸è®Š) ...

    async processSingleChat(token, chatId) {
        try {
            const latestMsg = await graphService.getLatestMessage(token, chatId);
            if (!latestMsg) return;

            const msgId = latestMsg.id;
            if (this.chatCheckpoints[chatId] === msgId) return;

            // æª¢æŸ¥æ˜¯å¦ç‚º Bot è‡ªå·±ç™¼çš„
            const senderId = (latestMsg.from && latestMsg.from.user) ? latestMsg.from.user.id : null;
            if (senderId === this.myUserId) {
                this.chatCheckpoints[chatId] = msgId;
                return;
            }

            // --- è™•ç†æ–°è¨Šæ¯ ---
            const senderName = latestMsg.from.user ? latestMsg.from.user.displayName : 'æœªçŸ¥';
            
            // [é—œéµ] åµæ¸¬æ˜¯å¦ç‚ºè²¼åœ–
            // Teams çš„è²¼åœ–é€šå¸¸æ˜¯ <img ... class="animated-sticker"> æˆ–åŒ…å«åœ¨ <div> ä¸­
            // ç°¡å–®åˆ¤æ–·ï¼šå¦‚æœæœ‰ <img ...> ä¸”çœ‹èµ·ä¾†åƒ stickerï¼Œæˆ–æ˜¯ç´”é™„ä»¶
            // é€™è£¡ç”¨ä¸€å€‹ç°¡å–®çš„ Regex æª¢æŸ¥ HTML ä¸­æ˜¯å¦åŒ…å« sticker é—œéµå­— (Teams ç‰¹æ€§)
            const rawBody = latestMsg.body.content || '';
            const isSticker = /sticker|giphy/i.test(rawBody) || (latestMsg.attachments && latestMsg.attachments.length > 0 && !rawBody.trim());
            
            const rawContent = rawBody.replace(/<[^>]*>/g, '').trim(); // è½‰ç´”æ–‡å­—

            console.log(`[${this.name}] æ”¶åˆ°ä¾†è‡ª ${senderName}: ${isSticker ? '[è²¼åœ–/é™„ä»¶]' : rawContent}`);
            this.chatCheckpoints[chatId] = msgId;

            // --- é‚è¼¯åˆ†æ”¯ ---

            // æƒ…å¢ƒ A: ä½¿ç”¨è€…å‚³é€è²¼åœ– -> çµæŸå°è©±
            if (isSticker) {
                const cleared = this.memory.clearSession(chatId);
                if (cleared) {
                    await graphService.sendHtmlReply(token, chatId, "å·²æ”¶åˆ°è²¼åœ–ï¼ŒçµæŸæœ¬æ¬¡å°è©±è¨˜æ†¶ã€‚");
                }
                return; // ä¸åšå¾ŒçºŒ LLM è™•ç†
            }

            // æƒ…å¢ƒ B: ä¸€èˆ¬æ–‡å­—è¨Šæ¯ -> è¨˜éŒ„ä¸¦å›æ‡‰
            if (rawContent) {
                // 1. è¨˜éŒ„ User è¨Šæ¯åˆ°è¨˜æ†¶é«”
                this.memory.addMessage(chatId, 'user', senderName, rawContent);

                // 2. å–å¾—ç›®å‰ç‚ºæ­¢çš„æ­·å²ç´€éŒ„ (çµ¦ LLM ç”¨)
                const history = this.memory.getHistory(chatId);
                
                // 3. å‘¼å« LLM (é€™è£¡æ¨¡æ“¬)
                // å¯¦éš›ä¸Šæ‚¨æœƒæŠŠ `history` é™£åˆ—æ•´å€‹ä¸Ÿçµ¦ OpenAI
                const replyText = await this.mockLlmResponse(history, senderName);

                // 4. ç™¼é€å›è¦†
                const htmlReply = formatter.convertMarkdownToHtml(replyText);
                await graphService.sendHtmlReply(token, chatId, htmlReply);

                // 5. [é‡è¦] è¨˜éŒ„ Bot çš„å›è¦†åˆ°è¨˜æ†¶é«” (é€™æ¨£ä¸‹æ¬¡æ‰æ¥å¾—ä¸Š)
                this.memory.addMessage(chatId, 'assistant', this.name, replyText);
            }

        } catch (e) {
            console.error(`[${this.name}] è™•ç†èŠå¤©å®¤ ${chatId} å¤±æ•—:`, e.message);
        }
    }

    // æ¨¡æ“¬ LLM (æ”¯æ´ Context)
    async mockLlmResponse(history, currentUserName) {
        // å–å¾—ä¸Šä¸€å¥ (æœ€è¿‘ä¸€å¥)
        const lastMsg = history[history.length - 1];
        
        // ç°¡å–®è¦å‰‡ï¼šå¦‚æœæ­·å²ç´€éŒ„è¶…é 1 å¥ï¼Œå°±è¡¨ç¤ºæœ‰ä¸Šä¸‹æ–‡
        if (history.length > 2) {
            return `(è¨˜æ†¶æ¨¡å¼) ${currentUserName}ï¼Œæˆ‘è¨˜å¾—æˆ‘å€‘å‰›å‰›åœ¨èŠ... æ‚¨ç¸½å…±èªªäº† ${Math.floor(history.length / 2)} æ¬¡è©±ã€‚`;
        } else {
            return `ä½ å¥½ ${currentUserName}ï¼Œé€™æ˜¯ä¸€å€‹æ–°çš„å°è©±é–‹å§‹ã€‚`;
        }
    }
}

module.exports = PollingBot;
3. é‡é»è§£æ
å¦‚ä½•åˆ¤æ–·è²¼åœ– (Sticker)?
Teams Graph API å°æ–¼è²¼åœ–çš„è™•ç†æœ‰é»æ··äº‚ï¼Œé€šå¸¸æœ‰å…©ç¨®å½¢å¼ï¼š

Giphy/Sticker: HTML body æœƒåŒ…å« <img src="..." alt="sticker">ï¼Œä¸” src å¾€å¾€ä¾†è‡ª giphy.com æˆ– Teams çš„ CDNã€‚

ç©ºè¨Šæ¯é™„ä»¶: æœ‰äº›è²¼åœ–æœƒè¢«è¦–ç‚º attachmentï¼Œå°è‡´ body.content å¹¾ä¹æ˜¯ç©ºçš„æˆ–åªæœ‰ <p>&nbsp;</p>ã€‚

æˆ‘åœ¨ç¨‹å¼ç¢¼ä¸­ä½¿ç”¨äº† isSticker çš„åˆ¤æ–·é‚è¼¯ï¼š

JavaScript
const isSticker = /sticker|giphy/i.test(rawBody) || (latestMsg.attachments.length > 0 && !rawContent);
é€™æ˜¯ä¸€å€‹é€šç”¨çš„åˆ¤å®šï¼Œæ‚¨å¯ä»¥æ ¹æ“šå¯¦éš›è§€å¯Ÿåˆ°çš„ HTML çµæ§‹ï¼ˆç”¨ console.log(rawBody) å°å‡ºä¾†çœ‹ï¼‰ä¾†å¾®èª¿ Regexã€‚

æ»‘å‹•è¦–çª— (5åˆ†é˜è¨ˆæ™‚)
åœ¨ MemoryManager çš„ _resetTimer æ–¹æ³•ä¸­ï¼š

æ¯æ¬¡å‘¼å« addMessage (User èªªè©±æˆ– Bot èªªè©±)ï¼ŒèˆŠçš„ setTimeout å°±æœƒè¢« clearTimeout å–æ¶ˆã€‚

ç„¶å¾Œå»ºç«‹ä¸€å€‹å…¨æ–°çš„ 5 åˆ†é˜å€’æ•¸ã€‚

é€™ç¢ºä¿äº†åªè¦å°è©±æŒçºŒé€²è¡Œï¼Œè¨˜æ†¶å°±ä¸æœƒæ¶ˆå¤±ï¼›åªæœ‰ç•¶é›™æ–¹éƒ½æ²‰é»˜ 5 åˆ†é˜å¾Œï¼Œè¨˜æ†¶é«”æ‰æœƒé‡‹æ”¾ã€‚

æ¸¬è©¦æ–¹å¼
æ¸¬è©¦è¨˜æ†¶ï¼š

User: "æˆ‘å«å°æ˜"

Bot: "ä½ å¥½å°æ˜" (å­˜å…¥è¨˜æ†¶)

User: "æˆ‘å‰›å‰›èªªæˆ‘å«ä»€éº¼ï¼Ÿ"

Bot (è®€å– History): "ä½ å«å°æ˜"

æ¸¬è©¦è²¼åœ–ä¸­æ–·ï¼š

(æ¥çºŒä¸Šæ–‡)

User: [å‚³é€ä¸€å¼µè²¼åœ–]

Bot: "å·²çµæŸæœ¬æ¬¡å°è©±è¨˜æ†¶ã€‚"

User: "æˆ‘å‰›å‰›èªªæˆ‘å«ä»€éº¼ï¼Ÿ"

Bot: "ä½ å¥½ï¼Œé€™æ˜¯ä¸€å€‹æ–°çš„å°è©±é–‹å§‹ã€‚" (å› ç‚ºè¨˜æ†¶å·²è¢«æ¸…é™¤)

æ¸¬è©¦è¶…æ™‚ï¼š

èªªå®Œè©±å¾Œï¼Œå»å–æ¯å’–å•¡ç­‰ 5 åˆ†é˜ã€‚

å›ä¾†å†å• Botï¼Œå®ƒæ‡‰è©²æœƒå¿˜è¨˜ä¹‹å‰çš„å°è©±ã€‚

æ˜¯robotæœ€å¾Œçš„å›è¦†æ”¶åˆ°ç‰¹å®šçš„è¡¨æƒ…ç¬¦è™Ÿ emojiï¼Œæ¯”å¦‚æ‰“å‹¾ï¼Œå‰‡çµ‚æ­¢å°è©±

é€™æ˜¯ä¸€å€‹éå¸¸ç¬¦åˆç›´è¦ºçš„äº’å‹•è¨­è¨ˆã€‚åœ¨ Teams ä¸­ï¼Œæˆ‘å€‘é€šå¸¸æœƒç”¨ã€Œå·²è®€ã€æˆ–ã€Œæ‰“å‹¾ã€ä¾†è¡¨ç¤ºã€Œæˆ‘çŸ¥é“äº†ã€çµæŸäº†ã€ã€‚

è¦å¯¦ä½œé€™å€‹åŠŸèƒ½ï¼Œæˆ‘å€‘ä¸éœ€è¦æ”¹è®Šæ¶æ§‹ï¼Œåªéœ€è¦åœ¨ src/bot.js çš„åˆ¤æ–·é‚è¼¯ä¸­ï¼ŒåŠ å…¥å° ç‰¹å®š Emoji (âœ…) çš„åµæ¸¬å³å¯ã€‚

ä¿®æ”¹æ€è·¯
è§£æå…§å®¹ï¼š æˆ‘å€‘å·²ç¶“æŠŠ HTML è½‰æˆç´”æ–‡å­— (rawContent) äº†ã€‚

åµæ¸¬è¦å‰‡ï¼š æª¢æŸ¥ rawContent æ˜¯å¦åŒ…å«æˆ‘å€‘æŒ‡å®šçš„ Emoji (ä¾‹å¦‚ âœ…, âœ”ï¸, ğŸ‘Œ)ã€‚

è§¸ç™¼å‹•ä½œï¼š å¦‚æœåµæ¸¬åˆ°äº†ï¼Œå°±å‘¼å« memory.clearSession() æ¸…é™¤è¨˜æ†¶ï¼Œä¸¦å›å‚³ä¸€å€‹ç°¡å–®çš„ç¢ºèª (æˆ–ä¸å›å‚³)ã€‚

ä¿®æ”¹ç¨‹å¼ç¢¼ (src/bot.js)
è«‹æ‰¾åˆ° processSingleChat æ–¹æ³•ï¼Œä¸¦åœ¨è™•ç† rawContent çš„åœ°æ–¹åŠ å…¥ä»¥ä¸‹é‚è¼¯ï¼š

JavaScript
// src/bot.js

// ... (å‰é¢çš„ç¨‹å¼ç¢¼)

    async processSingleChat(token, chatId) {
        try {
            // ... (å–å¾—æœ€æ–°è¨Šæ¯ã€æª¢æŸ¥ Checkpointã€æ’é™¤è‡ªå·±ç™¼çš„è¨Šæ¯) ...

            // --- è™•ç†æ–°è¨Šæ¯ ---
            const senderName = latestMsg.from.user ? latestMsg.from.user.displayName : 'æœªçŸ¥';
            
            // 1. å–å¾—ç´”æ–‡å­—å…§å®¹ (ç§»é™¤ HTML)
            const rawBody = latestMsg.body.content || '';
            const rawContent = rawBody.replace(/<[^>]*>/g, '').trim(); 

            // 2. [æ–°å¢] å®šç¾©çµ‚æ­¢å°è©±çš„ Emoji åˆ—è¡¨
            // æ‚¨å¯ä»¥åŠ å…¥ä»»ä½•æ‚¨æƒ³æ”¯æ´çš„ç¬¦è™Ÿï¼Œä¾‹å¦‚ï¼šæ‰“å‹¾ã€OKæ‰‹å‹¢ã€æˆ–æ˜¯æ–‡å­— "end"
            const terminationSymbols = ['âœ…', 'âœ”ï¸', 'â˜‘ï¸', 'ğŸ‘Œ', 'ğŸ‘'];
            
            // 3. [æ–°å¢] æª¢æŸ¥æ˜¯å¦ç‚ºçµ‚æ­¢è¨Šè™Ÿ
            // é€™è£¡ä½¿ç”¨ some() ä¾†æª¢æŸ¥å…§å®¹æ˜¯å¦åŒ…å«ä¸Šè¿°ä»»ä¸€ç¬¦è™Ÿ
            // æˆ–è€…ä½¿ç”¨ strict equal (===) ä¾†é™åˆ¶ã€Œåªèƒ½å‚³ä¸€å€‹ç¬¦è™Ÿã€æ‰ç®—æ•¸
            const isTermination = terminationSymbols.some(symbol => rawContent.includes(symbol));

            // 4. [ä¿®æ”¹] è²¼åœ–åˆ¤æ–· (åŸæœ¬çš„é‚è¼¯)
            const isSticker = /sticker|giphy/i.test(rawBody) || (latestMsg.attachments && latestMsg.attachments.length > 0 && !rawContent);

            console.log(`[${this.name}] æ”¶åˆ°ä¾†è‡ª ${senderName}: ${rawContent} (çµ‚æ­¢è¨Šè™Ÿ: ${isTermination})`);
            this.chatCheckpoints[chatId] = msgId;

            // --- é‚è¼¯åˆ†æ”¯ ---

            // æƒ…å¢ƒ A: æ”¶åˆ°ã€Œçµ‚æ­¢ Emojiã€æˆ–ã€Œè²¼åœ–ã€ -> çµæŸå°è©±
            if (isTermination || isSticker) {
                const cleared = this.memory.clearSession(chatId);
                
                if (cleared) {
                    // [é¸ç”¨] æ‚¨å¯ä»¥é¸æ“‡å›å‚³ä¸€å¥ã€Œå°è©±å·²çµæŸã€ï¼Œæˆ–æ˜¯å®‰éœåœ°çµæŸ
                    // å¦‚æœæ˜¯æ‰“å‹¾ï¼Œé€šå¸¸å®‰éœçµæŸæˆ–å›ä¸€å€‹ç°¡å–®çš„ "Bye" é«”é©—æ¯”è¼ƒå¥½
                    await graphService.sendHtmlReply(token, chatId, "ğŸ‘Œ (å°è©±è¨˜æ†¶å·²æ¸…é™¤)");
                }
                return; // çµæŸï¼Œä¸é€çµ¦ LLM
            }

            // æƒ…å¢ƒ B: ä¸€èˆ¬æ–‡å­—è¨Šæ¯ -> è¨˜éŒ„ä¸¦å›æ‡‰ (ä¿æŒåŸæœ¬é‚è¼¯)
            if (rawContent) {
                this.memory.addMessage(chatId, 'user', senderName, rawContent);
                const history = this.memory.getHistory(chatId);
                
                // å‘¼å« LLM...
                const replyText = await this.mockLlmResponse(history, senderName);

                const htmlReply = formatter.convertMarkdownToHtml(replyText);
                await graphService.sendHtmlReply(token, chatId, htmlReply);

                this.memory.addMessage(chatId, 'assistant', this.name, replyText);
            }

        } catch (e) {
            console.error(`[${this.name}] è™•ç†èŠå¤©å®¤ ${chatId} å¤±æ•—:`, e.message);
        }
    }

// ... (å¾Œé¢çš„ç¨‹å¼ç¢¼)
é‡é»èªªæ˜
terminationSymbols é™£åˆ—ï¼š

æˆ‘å»ºè­°å¤šæ”¾å¹¾å€‹é¡ä¼¼çš„ç¬¦è™Ÿï¼Œå› ç‚ºä½¿ç”¨è€…å¯èƒ½æœƒç”¨åˆ°ä¸åŒç‰ˆæœ¬çš„æ‰“å‹¾ (ä¾‹å¦‚ç¶ è‰²æ‰“å‹¾ âœ… æˆ–é»‘è‰²æ‰“å‹¾ âœ”ï¸)ã€‚

æˆ‘ä¹ŸåŠ å…¥äº† ğŸ‘ï¼Œå› ç‚ºå¾ˆå¤šä½¿ç”¨è€…ç¿’æ…£æŒ‰è®šä¾†çµæŸå°è©±ã€‚

åˆ¤æ–·æ–¹å¼ (includes vs ===)ï¼š

rawContent.includes(symbol): åªè¦è¨Šæ¯åŒ…å«æ‰“å‹¾å°±ç®—ã€‚ä¾‹å¦‚ä½¿ç”¨è€…å›ï¼šã€Œæ²’å•é¡Œ âœ…ã€ï¼Œé€™æ¨£ä¹Ÿæœƒè§¸ç™¼æ¸…é™¤è¨˜æ†¶ã€‚é€™é€šå¸¸æ¯”è¼ƒæ–¹ä¾¿ã€‚

rawContent === symbol: ä½¿ç”¨è€…å¿…é ˆåªå‚³é€ã€Œâœ…ã€ä¸€å€‹å­—æ‰ç®—ã€‚é€™æ¯”è¼ƒåš´æ ¼ï¼Œé¿å…èª¤åˆ¤ã€‚

ä¸Šé¢çš„ç¯„ä¾‹æ˜¯ä½¿ç”¨ includes (å¯¬é¬†æ¨¡å¼)ã€‚

Teams çš„ "Reaction" (é‡è¦å€åˆ¥)ï¼š

ä¸Šé¢çš„ç¨‹å¼ç¢¼è™•ç†çš„æ˜¯ä½¿ç”¨è€…ã€Œç™¼é€ä¸€å‰‡æ–°è¨Šæ¯ã€ï¼Œå…§å®¹æ˜¯ Emojiã€‚

å¦‚æœä½¿ç”¨è€…æ˜¯åœ¨æ‚¨ Robot çš„è¨Šæ¯ä¸ŠæŒ‰å³éµ -> é»é¸ Emoji åæ‡‰ (Reaction)ï¼š

Graph API çš„ Polling æ©Ÿåˆ¶å¾ˆé›£åµæ¸¬åˆ°é€™å€‹å‹•ä½œï¼ˆå› ç‚ºé‚£ä¸æœƒç”¢ç”Ÿã€Œæ–°è¨Šæ¯ã€ï¼Œè€Œæ˜¯æ›´æ–°ã€ŒèˆŠè¨Šæ¯ã€ï¼‰ã€‚

ç‚ºäº†é–‹ç™¼ç°¡å–®èˆ‡ç©©å®šæ€§ï¼Œå»ºè­°å¼•å°ä½¿ç”¨è€…**ã€Œè«‹å›è¦† âœ… çµæŸå°è©±ã€**ï¼Œè€Œä¸æ˜¯å»æŒ‰é‚£å€‹åæ‡‰æŒ‰éˆ•ã€‚

æ¸¬è©¦æµç¨‹
å•Ÿå‹• Robotã€‚

User: "ä½ å¥½ï¼Œä»Šå¤©å¤©æ°£å¦‚ä½•ï¼Ÿ" (Robot å›ç­”ï¼Œå»ºç«‹è¨˜æ†¶)

User: "é‚£æ˜å¤©å‘¢ï¼Ÿ" (Robot æ ¹æ“šè¨˜æ†¶å›ç­”)

User: "âœ…" (æˆ– "å¥½çš„ âœ…")

Robot: "ğŸ‘Œ (å°è©±è¨˜æ†¶å·²æ¸…é™¤)"

User: "æ˜å¤©å‘¢ï¼Ÿ"

Robot: "ä½ å¥½ï¼Œé€™æ˜¯ä¸€å€‹æ–°çš„å°è©±é–‹å§‹ã€‚" (å› ç‚ºè¨˜æ†¶å·²è¢«æ¸…é™¤ï¼Œå®ƒå¿˜è¨˜äº†ä¸Šä¸‹æ–‡)
